name: "CD Prod"

on: 
  push:
    branches: main

jobs:
  android-deploy:
    name: Android Deploy
    runs-on: ubuntu-latest
    steps: 
    - name: Checkout no cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.6'
        channel: 'stable'
        cache: true
    
    - name: Flutter pub get
      run: flutter pub get

    - name: Generate keyproperties
      run: |
        cd android
        touch key.properties
        echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" >> key.properties
        echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> key.properties
        echo "keyAlias=upload" >> key.properties
        echo "storeFile=./keystore.jks" >> key.properties
        cat key.properties

    - name: Decode keystore
      env:
        ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
      run: echo "$ANDROID_KEYSTORE" | base64 -d >> ./android/app/keystore.jks
    
    - name: Build appbundle
      run: flutter build appbundle --release

    - name: Setup Authorization with Google Play Store
      run: echo '${{ secrets.GOOGLE_PLAY_ACCESS_KEY }}' > service_account.json

    - name: Deploy bundle to Google Play
      uses: r0adkll/upload-google-play@v1.1.3
      with:
        serviceAccountJson: service_account.json
        packageName: com.txtsoftwares.sorteador
        releaseFiles: build/app/outputs/bundle/release/app-release.aab
        track: "internal"
        status: "completed"
    
    - name: Upload Appbundle
      uses: actions/upload-artifact@v4
      with:
        name: appbundle-release
        path: build/app/outputs/bundle/release/app-release.aab