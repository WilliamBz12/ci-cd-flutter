name: "CD Prod"

on: 
  push:
    branches: main

jobs:
  android-deploy:
    name: Android Deploy
    runs-on: ubuntu-latest
    steps: 
    - name: Checkout no código
      uses: actions/checkout@v4

    - name: Configurar Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.6'
        channel: 'stable'
        cache: true
    
    - name: Flutter pub get
      run: flutter pub get

    - name: Generate keyproperties
      run: |
        cd android
        touch key.properties
        echo "storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}" >> key.properties
        echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> key.properties
        echo "keyAlias=upload" >> key.properties
        echo "storeFile=./app/keystore.jks" >> key.properties
        cat key.properties

    - name: Decode keystore
      env:
        ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
      run: echo "$ANDROID_KEYSTORE" | base64 -d >> ./android/app/keystore.jks
    
    - name: Build appbundle
      run: flutter build appbundle --release

    - name: Setup Authorization with Google Play Store
      run: echo '${{ secrets.GOOGLE_PLAY_ACCESS_KEY }}' > service_account.json

    - name: Deploy bundle to Google Play
      uses: r0adkll/upload-google-play@v1.1.3
      with:
        serviceAccountJson: service_account.json
        packageName: com.txtsoftwares.sorteador
        releaseFiles: build/app/outputs/bundle/release/app-release.aab
        track: "internal"
        status: "draft"
    
    - name: Upload Appbundle
      uses: actions/upload-artifact@v4
      with:
        name: appbundle-release
        path: build/app/outputs/bundle/release/app-release.aab

  ios-deploy:
    name: iOS Deploy
    runs-on: macos-14
    steps:
      - name: Checkout no código
        uses: actions/checkout@v4

      - name: Configurar Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true
      
      - name: Install last version of Xcode
        uses: maxim-lobanov/setup-xcode@v1.6.0
        with:
          xcode-version: '16.2'
          cache: true
      
      - name: List available iOS SDKs
        run: xcodebuild -showsdks | grep -i ios || echo "No iOS SDKs found"
  
      - name: Set iOS .env Variables
        run: |
          echo "MATCH_PASSWORD=${{ secrets.MATCH_PASSWORD }}" >> $GITHUB_ENV
          echo "TEAM_ID=${{ secrets.TEAM_ID }}" >> $GITHUB_ENV
          echo "KEYCHAIN_NAME=${{ secrets.KEYCHAIN_NAME }}" >> $GITHUB_ENV
          echo "KEY_ID=${{ secrets.KEY_ID }}" >> $GITHUB_ENV
          echo "ISSUER_ID=${{ secrets.ISSUER_ID }}" >> $GITHUB_ENV
          echo "KEY_P8=${{ secrets.KEY_P8 }}" >> $GITHUB_ENV
          echo "MATCH_GIT_BASIC_AUTHORIZATION=${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}" >> $GITHUB_ENV

      - name: Flutter pub get
        run: flutter pub get

      - name: Build iOS (PROD)
        run: flutter build ipa --no-codesign --release 
      
      - name: Install Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7.2
          bundler-cache: true

      - name: Fastlane iOS
        uses: maierj/fastlane-action@v2.0.1
        with:
          lane: 'release_draft'
          subdirectory: 'ios'